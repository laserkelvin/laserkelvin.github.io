<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/fontawesome.min.css" integrity="sha384-jLKHWM3JRmfMU0A5x5AkjWkw/EYfGUAGagvnfryNV3F9VqM98XiIH7VBGVoxVSc7" crossorigin=anonymous > <link rel=stylesheet  href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css"> <link rel=stylesheet  href="/css/tufte.css"> <link rel=stylesheet  href="/css/latex.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=icon  href="/assets/favicon.ico"> <title>How to buy a new CPU - the hard way</title> <div id=layout > <div id=menu > <ul> <li><a href="/">Home</a> <li><a href="/blog/">Blog</a> <li><a href="/projects/">Projects</a> <li><a href="/resume/">CV</a> <li><a href="/about/">About me</a> </ul> </div> <div id=main > <div class=franklin-content ><h1 id=fill_title ><a href="#fill_title" class=header-anchor >How to buy a new CPU - the hard way</a></h1> <p>It&#39;s my first blog post in a while, and it&#39;s completely different from the things I normally or would like to talk about, but it was something that drove me up the wall enough for me to want to document it in the hope of helping someone else out there on the internet&#33; Just as a disclaimer: everything written in this post documents <em>my</em> experience; views are my own and not of my employer, and I am not responsible for any damage to property or harm to readers who try and replicate these steps.</p> <p>I recently made the swap over to an Intel CPU&mdash;my previous was a Ryzen 3700X which has worked for me quite faithfully since the pandemic. A change between vendors as well as CPU generations generally requires a change in motherboard as well, and with this comes some nice things like faster DDR &#40;I went from low end DDR4 to high&#40;er&#41; end DDR5&#41; and for those who do their research well, features like BIOS Flashback. To a large extent, that is the moral of this blog post: there <em>are</em> actually useful new features on motherboards, ones that might be worth spending the extra little bit of money if you&#39;re buying a brand new CPU.</p> <p>That brings us to the core of the issue: I bought a fairly new model/SKU, the 14700K, from the Raptor Lake refresh line, which came to retail around October this year. With such a recent release, buying a motherboard isn&#39;t as simple as reading &quot;Supports XXX Gen&quot; from the manufacturer, as chances are, the BIOS will need to be updated before you can use your spanking new processor. This isn&#39;t so much of a problem if you have an older CPU that fits in the same socket, but quickly starts becoming a chicken or the egg problem. So what&#39;s the solution?</p> <h2 id=asus_flashback ><a href="#asus_flashback" class=header-anchor >ASUS Flashback</a></h2> <p>Allegedly, newer and slightly pricier ASUS motherboards have a feature called &quot;BIOS Flashback&quot;. What this lets you do is put a new BIOS &#40;<code>.CAP</code> file&#41; on a USB stick with a FAT16/32 filesystem, plug it into a specially marked USB port in the back, and push a button. What a world we live in now&#33;</p> <p><img src="https://kmpic.asus.com/images/2020/04/07/e1f025f6-a4cd-4a6b-aeb6-b001e29032c6.png" alt=asus-flashback  /></p> <p>Image pulled from the ASUS support pages. According to the documentation, you just hold the button for three seconds, causing it to flash three times and in about eight minutes you&#39;ll be in your new BIOS version&#33;</p> <p>Now that I&#39;ve described what <em>can</em> be done, I&#39;ll detail what I ended up <em>having</em> to do.</p> <h2 id=narrative_for_those_who_care ><a href="#narrative_for_those_who_care" class=header-anchor >Narrative; for those who care</a></h2> <p>I seldom make life easy for myself, despite the fact that I often pass to others advice my PhD advisor gave me. <label for=sn-1  class="margin-toggle sidenote-number"></label> <input type=checkbox  id=mn-1  class=margin-toggle /> <span class=sidenote  id=sn-1 >It's something to the tune of one hour in the library will save you one month in the lab; basically do your prior research/reading, and you won't have to waste time and effort to realize something.</span> In this case, I had the naive intention that I would just skimp on a motherboard as I intended to upgrade later when some cooler processors come out &#40;especially with NPU units, newer instruction sets, etc.&#41;. </p> <p>I ended up buying the ASUS Z790-P to go with my 14700K <label for=sn-2  class="margin-toggle sidenote-number"></label> <input type=checkbox  id=mn-2  class=margin-toggle /> <span class=sidenote  id=sn-2 >Notably, it *does not* have the ASUS Flashback feature.</span> and after close to two hours of cleaning, taking out the guts, rewiring everything, and finally putting it all together, <strong>it would not boot</strong>. The power button light blinked slowly at me as if it didn&#39;t understand my intentions. I opened the case back up, rejigged some wires, and still to no avail. Eventually, it dawned on me that the BIOS might need to be upgraded, given how new my processor was&#33; </p> <p>Doing some googling, I looked to see where to download the newest BIOS version, and at the same time, how do I upgrade if I can&#39;t even boot? A few pages in I realized I was up shit creek without a paddle: everything I could find on Reddit, etc. suggested ASUS Flashback, which I desperately searched for in the Z790-P manual in vain. Eventually, I stumbled upon the less traversed roads of the internet, older electronics forums and the like. Many posts talked about a CH341A programmer tool, which lead me to ordering one on Amazon immediately.</p> <h2 id=flashing_your_biosmdashthe_hard_way ><a href="#flashing_your_biosmdashthe_hard_way" class=header-anchor >Flashing your BIOS&mdash;the hard way</a></h2> <p>Now I&#39;ll cut to the chase. I originally had very little idea what I was doing, and in honesty, I&#39;ve never had to flash a ROM in such an <em>ad hoc</em> way: the closest is probably plugging some microcontroller into a laptop that controls a stepper motor, and passing it instructions &#40;e.g. number of steps to take, etc.&#41;. Once you get over how daunting &quot;flashing your motherboard BIOS&quot; sounds, it really isn&#39;t actually too hard&mdash;thankfully. At a high level, these are the steps:</p> <ol> <li><p>Order a CH341A programmer on express shipping, because you&#39;re impatient</p> <li><p>Unplug AC from the power supply</p> <li><p>Find the BIOS chip on your motherboard</p> <li><p>Match pins of the CH341A with the BIOS chip</p> <li><p>Plug the CH341A into a laptop</p> <li><p>Download and backup the image already on the chip</p> <li><p>Write the new image</p> <li><p>Plug things back in, boot and wait a few minutes while firmware updates</p> <li><p>???</p> <li><p>Profit</p> </ol> <h3 id=the_ch341a ><a href="#the_ch341a" class=header-anchor >The CH341A</a></h3> <p>The CH341A truly looks like a hobbyist electronics geek&#39;s toy:</p> <p><img src="/assets/ch341a.jpg" alt=ch341a  /></p> <p>The part with the USB dongle is the CH341A unit, and the clamp is what is used to attach to soldered on BIOS chips &#40;which is the more common approach these days, as I understand it&#41;. The red wire helpfully informs the user that is &quot;Pin 1&quot;, which is used to match up the CH341A and the chip side. On the CH341A, the 8-pin connector &#40;not the clamp&#41; is connected to the CH341A by first raising the lever, inserting the connector, then dropping the lever to lock the pins in place. The red wire should face the lever side.</p> <p>For pictures, I&#39;ll point the reader to <a href="https://winraid.level1techs.com/t/guide-the-beginners-guide-to-using-a-ch341a-spi-programmer-flasher-with-pictures/33041">this forum post</a> which actually provided the majority of the run commands, but I provide a bit more information from my own specific experience.</p> <h3 id=the_motherboard_bios_chip ><a href="#the_motherboard_bios_chip" class=header-anchor >The Motherboard BIOS chip</a></h3> <p>It seemed like certain brands annotate the BIOS chip, and location will vary. The Z790-P manual doesn&#39;t indicate where the chip is, nor is it annotated on the board itself. Thankfully, WinBond appears to be a fairly ubiquitous chip, and a lot of forum posts I&#39;ve seen show images of them. In these cases, they are 8-pin &#40;4 on each side&#41; chips that look like this:</p> <p><img src="https://http2.mlstatic.com/D_NQ_NP_861031-MLB49735450790_042022-F.jpg" alt=winbond  /></p> <p>The notch on the lower left corner indicates Pin 1&mdash;matching the red wire with the CH341A.</p> <h3 id=preparing_to_flash ><a href="#preparing_to_flash" class=header-anchor >Preparing to flash</a></h3> <p>Somewhat interestingly, I found the flashing process to be pretty straight forward on Linux. I used a laptop running Fedora 39, and I was able to install the two tools that are needed to carry out the whole process.</p> <p>First, <code>flashrom</code> can be obtained via <code>dnf</code>. This is the tool that will actually interface with the USB dongle/CH341A in a surprisingly seamless way: I didn&#39;t have to do any weird <code>udev</code> rules to make things work and it was just plug and play.</p> <p>The second tool, <a href="https://github.com/LongSoft/UEFITool"><code>uefitool</code></a>, I got from the Github repository. I didn&#39;t want to bother downloading Qt, so I just built binary from source, nominally just needing <code>cmake</code>, <code>make</code>, and GNU compilers &#40;i.e. <code>gcc</code>&#41;. You then get an executable <code>uefiextract</code> built. The point of this tool is to extract out the binary from an ASUS <code>.CAP</code> file, which is what you download from the support pages. The key thing with flashing BIOS/ROMs is that the chips have a <em>very</em> specific capacity &#40;16 MB in my case&#41;, and the <code>.CAP</code> files allegedly contain some header that pads the file out to ~25 MB or so. All I did was run <code>uefiextract &lt;.cap file&gt; all</code> with the <code>.CAP</code> file in the same folder as the binary, and it created a <code>&lt;file&gt;.dump</code> folder containing a filestructure that matches that of the downloaded <code>.CAP</code> file. Each folder contains a <code>body.bin</code>, and for the most part it is just a matter of finding the <code>body.bin</code> that matches your expected capacity; everything else for me at least was on the order of kB.</p> <h3 id=executing_the_flash ><a href="#executing_the_flash" class=header-anchor >Executing the flash</a></h3> <p>So at this point, disconnected the PC from AC power and brought it to a working space. The CH341A cable is pretty short, and you&#39;ll need room to plug the dongle into your laptop and be close enough to your motherboard. Probably the best way would be to actually not have the motherboard mounted in your chassis yet, but I didn&#39;t want to take it out again.</p> <p>I left everything else connected within the PC, except the GPU which I disconnected from the PSU and from the motherboard. I don&#39;t think this was necessary, but my BIOS chip was situated right under where the GPU was mounted, and so it gave me extra room to work with. I suggest clamping the chip first, making sure to match the red wire position with the notch on the chip. Once it&#39;s secure, plug the dongle into the laptop, and one of the two LEDs will light up &#40;the POWER one&#41;. In some posts I read, they showed green and red LEDs to indicate status, but mine only showed red.</p> <p>Once it&#39;s plugged in, you can test the connection and try and red from the chip with:</p> <pre><code class="console hljs">sudo flashrom --programmer ch341a_spi -r backup_image.bin</code></pre>
<p>This will validate your connection, and the dumped binary will also confirm how big your expected image <em>needs</em> to be. At this point, the remaining LED lit up for me, and actually took a good  few minutes to copy over. </p>
<p>Now, navigate to where you ran <code>uefiextract</code>, and find the correct-sized <code>body.bin</code> &#40;<code>REGION</code>&#41;. You can then run:</p>
<pre><code class="console hljs">sudo flashrom --programmer ch341a_spi -w body.bin</code></pre>
<p>This will take longer than the prior step, and at the end will run a verification step. Note  that thankfully, <code>flashrom</code> will stop you from flashing the wrong image size: there does seem to be good safeguards with the tool&#33;</p>
<h2 id=epilogue ><a href="#epilogue" class=header-anchor >Epilogue</a></h2>
<p>Plug in your AC power and video output &#40;HDMI/VGA <em>on the motherboard</em>&#41;, cross your fingers, and hit the power button. At first, my case was still doing the slow blinking, but it  later turned into a solid light&mdash;the screen also showed that some ME firmware was being updated as well, and took a few minutes.</p>
<div class=page-foot >
  <div class=copyright >
    &copy; Kelvin Lee. Last modified: January 01, 2024. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and <a href="https://julialang.org">Julia</a>.
  </div>
</div>
</div>
        </div> 
    </div>